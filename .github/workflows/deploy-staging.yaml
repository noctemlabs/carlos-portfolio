name: deploy-staging

on:
  workflow_run:
    workflows: ["build-images"]
    types: [completed]

concurrency:
  group: deploy-staging
  cancel-in-progress: false

permissions:
  contents: read
  packages: read

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: [self-hosted, rpi-staging]
    env:
      KUBECONFIG: /home/actions/.kube/config
    steps:
      - uses: actions/checkout@v4

      - name: Resolve tag from triggering SHA
        shell: bash
        run: |
          SHA='${{ github.event.workflow_run.head_sha }}'
          TAG="$(git describe --tags --exact-match "$SHA" 2>/dev/null || true)"
          if [[ -z "$TAG" ]]; then
            echo "No tag found for SHA $SHA; skipping deploy."
            exit 0
          fi
          echo "TAG=$TAG" >> $GITHUB_ENV
          echo "Deploying tag: $TAG"

      - name: Deploy manifests
        run: |
          kubectl apply -f k8s/base/namespace.yaml
          kubectl apply -f k8s/profile-service/all.yaml
          kubectl apply -f k8s/frontend-bff/all.yaml

      - name: Pin images to release tag
        run: |
          kubectl -n noctem-portfolio set image deploy/profile-service profile-service=ghcr.io/noctemlabs/profile-service:${TAG}
          kubectl -n noctem-portfolio set image deploy/frontend-bff frontend-bff=ghcr.io/noctemlabs/frontend-bff:${TAG}

      - name: Wait for rollout
        run: |
          kubectl -n noctem-portfolio rollout status deploy/profile-service
          kubectl -n noctem-portfolio rollout status deploy/frontend-bff