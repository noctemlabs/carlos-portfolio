name: deploy-prod

on:
  workflow_run:
    workflows: ["build-images"]
    types: [completed]

concurrency:
  group: deploy-prod
  cancel-in-progress: false

permissions:
  contents: read
  packages: read

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Compute image tags
        id: meta
        shell: bash
        run: |
          SHA='${{ github.event.workflow_run.head_sha }}'
          SHORT_SHA="${SHA:0:7}"
          echo "sha_tag=sha-${SHORT_SHA}" >> "$GITHUB_OUTPUT"
          echo "latest_tag=latest" >> "$GITHUB_OUTPUT"
          echo "Computed sha tag: sha-${SHORT_SHA}"

      - name: SSH deploy to EC2 (kind)
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.PROD_EC2_HOST }}
          username: ${{ secrets.PROD_EC2_USER }}   # ubuntu
          key: ${{ secrets.PROD_EC2_SSH_KEY }}
          script: |
            set -euo pipefail

            REPO_DIR="/home/ubuntu/carlos-portfolio"
            SHA_TAG="${{ steps.meta.outputs.sha_tag }}"
            FALLBACK_TAG="${{ steps.meta.outputs.latest_tag }}"

            cd "$REPO_DIR"
            git fetch --all --prune

            echo "Attempting deploy with tag: $SHA_TAG (fallback: $FALLBACK_TAG)"

            kubectl apply -f k8s/base/namespace.yaml
            kubectl apply -f k8s/base/profile-service
            kubectl apply -f k8s/base/frontend-bff
            kubectl apply -f k8s/base/web
            kubectl apply -f k8s/overlays/kind/ingress.yaml

            # Try sha tag first; fallback to latest if image pull fails later
            kubectl -n noctem-portfolio set image deploy/profile-service profile-service=ghcr.io/noctemlabs/profile-service:${SHA_TAG} || \
              kubectl -n noctem-portfolio set image deploy/profile-service profile-service=ghcr.io/noctemlabs/profile-service:${FALLBACK_TAG}

            kubectl -n noctem-portfolio set image deploy/frontend-bff frontend-bff=ghcr.io/noctemlabs/frontend-bff:${SHA_TAG} || \
              kubectl -n noctem-portfolio set image deploy/frontend-bff frontend-bff=ghcr.io/noctemlabs/frontend-bff:${FALLBACK_TAG}

            kubectl -n noctem-portfolio set image deploy/web web=ghcr.io/noctemlabs/web:${SHA_TAG} || \
              kubectl -n noctem-portfolio set image deploy/web web=ghcr.io/noctemlabs/web:${FALLBACK_TAG}

            kubectl -n noctem-portfolio rollout status deploy/profile-service --timeout=300s
            kubectl -n noctem-portfolio rollout status deploy/frontend-bff --timeout=300s
            kubectl -n noctem-portfolio rollout status deploy/web --timeout=300s

            kubectl -n noctem-portfolio get pods -o wide
            kubectl -n noctem-portfolio get ingress
