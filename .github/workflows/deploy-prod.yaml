name: deploy-prod

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag to deploy (e.g. 1.3.1)"
        required: true

concurrency:
  group: deploy-prod
  cancel-in-progress: false

permissions:
  contents: read
  packages: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: SSH deploy to EC2 (kind)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PROD_EC2_HOST }}
          username: ${{ secrets.PROD_EC2_USER }}
          key: ${{ secrets.PROD_EC2_SSH_KEY }}
          script_stop: true
          script: |
            set -euo pipefail

            REPO_DIR="/home/ubuntu/carlos-portfolio"
            TAG="${{ inputs.tag }}"

            cd "$REPO_DIR"
            git fetch --all --tags --prune

            # Ensure tag exists and check it out for deterministic manifests
            git rev-parse "refs/tags/$TAG" >/dev/null 2>&1 || (echo "Tag $TAG not found on EC2" && exit 1)
            git checkout -f "refs/tags/$TAG"

            echo "Deploying tag=$TAG"

            kubectl apply -f k8s/base/namespace.yaml
            kubectl apply -f k8s/base/profile-service
            kubectl apply -f k8s/base/frontend-bff
            kubectl apply -f k8s/base/web

            kubectl apply -f k8s/overlays/kind/ingress.yaml

            kubectl -n noctem-portfolio set image deploy/profile-service profile-service=ghcr.io/noctemlabs/profile-service:$TAG
            kubectl -n noctem-portfolio set image deploy/frontend-bff frontend-bff=ghcr.io/noctemlabs/frontend-bff:$TAG
            kubectl -n noctem-portfolio set image deploy/web web=ghcr.io/noctemlabs/web:$TAG

            kubectl -n noctem-portfolio rollout status deploy/profile-service --timeout=180s
            kubectl -n noctem-portfolio rollout status deploy/frontend-bff --timeout=180s
            kubectl -n noctem-portfolio rollout status deploy/web --timeout=180s

            kubectl -n noctem-portfolio get pods -o wide
            kubectl -n noctem-portfolio get ingress
            echo "Deployment of tag=$TAG completed successfully"