name: deploy-prod

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write
  packages: read

concurrency:
  group: deploy-prod
  cancel-in-progress: false

jobs:
  gitops-promote:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      # Optional but nice: make sure build-images already pushed these images
      - name: Login to GHCR (read)
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GHCR_TOKEN }}

      - name: Verify images exist for tag
        shell: bash
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME}"

          for IMG in profile-service frontend-bff web; do
            echo "Checking ghcr.io/noctemlabs/${IMG}:${TAG}"
            docker manifest inspect "ghcr.io/noctemlabs/${IMG}:${TAG}" >/dev/null
          done

      - name: Update prod overlay image tags
        shell: bash
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME}"
          FILE="k8s/overlays/prod/kustomization.yaml"

          # Replace the three newTag values in-place
          perl -0777 -i -pe "s|(name:\s*ghcr\.io/noctemlabs/profile-service\s*\n\s*newTag:\s*).+|\${1}${TAG}|g" "$FILE"
          perl -0777 -i -pe "s|(name:\s*ghcr\.io/noctemlabs/frontend-bff\s*\n\s*newTag:\s*).+|\${1}${TAG}|g" "$FILE"
          perl -0777 -i -pe "s|(name:\s*ghcr\.io/noctemlabs/web\s*\n\s*newTag:\s*).+|\${1}${TAG}|g" "$FILE"

          echo "Updated prod kustomization:"
          grep -n "name:\|newTag:" "$FILE"

      - name: Commit and push promotion to main
        shell: bash
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME}"

          git config user.name "github-actions"
          git config user.email "github-actions@users.noreply.github.com"

          git add k8s/overlays/prod/kustomization.yaml
          git commit -m "chore(prod): promote ${TAG}" || exit 0
          git push origin main
