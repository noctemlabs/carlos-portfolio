name: deploy-prod

on:
  workflow_run:
    workflows: ["build-images"]
    types: [completed]

concurrency:
  group: deploy-prod
  cancel-in-progress: false

permissions:
  contents: read
  packages: read

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Resolve tag (prod requires a tag)
        id: tag
        shell: bash
        run: |
          SHA='${{ github.event.workflow_run.head_sha }}'
          TAG="$(git describe --tags --exact-match "$SHA" 2>/dev/null || true)"
          if [[ -z "$TAG" ]]; then
            echo "No tag found for $SHA; skipping prod deploy."
            echo "tag=" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Resolved tag: $TAG"

      - name: SSH deploy to EC2 (kind)
        if: ${{ steps.tag.outputs.tag != '' }}
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PROD_EC2_HOST }}
          username: ${{ secrets.PROD_EC2_USER }}
          key: ${{ secrets.PROD_EC2_SSH_KEY }}
          script_stop: true
          script: |
            set -euo pipefail

            REPO_DIR="/home/${{ secrets.PROD_EC2_USER }}/carlos-portfolio"
            SHA="${{ github.event.workflow_run.head_sha }}"
            TAG="${{ steps.tag.outputs.tag }}"

            if [[ ! -d "$REPO_DIR/.git" ]]; then
              echo "Repo not found at $REPO_DIR. Clone it first."
              exit 1
            fi

            cd "$REPO_DIR"
            git fetch --all --tags --prune
            git checkout -f "$SHA"

            echo "Deploying SHA=$SHA TAG=$TAG"

            kubectl apply -f k8s/base/namespace.yaml
            kubectl apply -f k8s/base/profile-service
            kubectl apply -f k8s/base/frontend-bff
            kubectl apply -f k8s/base/web

            kubectl apply -f k8s/overlays/kind/ingress.yaml

            kubectl -n noctem-portfolio set image deploy/profile-service profile-service=ghcr.io/noctemlabs/profile-service:$TAG
            kubectl -n noctem-portfolio set image deploy/frontend-bff frontend-bff=ghcr.io/noctemlabs/frontend-bff:$TAG
            kubectl -n noctem-portfolio set image deploy/web web=ghcr.io/noctemlabs/web:$TAG

            kubectl -n noctem-portfolio rollout status deploy/profile-service --timeout=180s
            kubectl -n noctem-portfolio rollout status deploy/frontend-bff --timeout=180s
            kubectl -n noctem-portfolio rollout status deploy/web --timeout=180s

            kubectl -n noctem-portfolio get pods -o wide
            kubectl -n noctem-portfolio get ingress
